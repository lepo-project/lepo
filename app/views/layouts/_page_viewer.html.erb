<iframe src="blank.mp3" allow="autoplay" style="display:none;" />

<video-js id="audio-player" class="video-js vjs-time-control" style="display:none;">
	<source src="<%= pg['audio_file_path'] %>">
</video-js>
<iframe id="page-frame" name="page-frame" src="<%= pg['file_path'] %>" frameborder="0" marginheight="0" marginwidth="0" style="opacity: 0;"></iframe>

<div id="sticky-panel">
	<%= render(partial: 'stickies/sticky_panel', locals: { stickies: pg['stickies'] }) %>
</div>

<%= render partial: 'layouts/highlight_btns' %>

<script>
	document.getElementById('page-frame').onload = function(e){
		this.style.opacity = 1;
		var iframeWin = this.contentWindow
		var iframeDoc = iframeWin.document

		// Make keyBinder to work even when clicking the content in the iframe
		keyBinder($(iframeWin));

		<% if @course %>
		showCreateHighlightBtns($(iframeDoc), iframeDoc);
		<% case pg['file_type'] when 'pdf' %>
		// Set color for text selection
		$(this.contentDocument).find("head").append($('<style>#pdfjs_viewer-minimal .textLayer ::selection {background-color: #acf;} #pdfjs_viewer-minimal *::-moz-selection {background-color: #acf;}</style>'))
		this.contentDocument.addEventListener('textlayerrendered', function (e) {
			<% current_user.highlight_texts(@course.lesson_note(session[:id]).id, pg['file_id']).each do |highlight| %>
			showHighlight(this, 'textLayer', <%= highlight[0] %>, "<%= highlight[1] %>");
			<% end %>
		}, true);
		<% when 'html' %>
		<% current_user.highlight_texts(@course.lesson_note(session[:id]).id, pg['file_id']).each do |highlight| %>
		showHighlight(this.contentDocument, '', <%= highlight[0] %>, "<%= highlight[1] %>");
		<% end %>
		<% end %>
		<% end %>
		<% unless pg['audio_file_path'].blank? %>
			if (videojs.getPlayer('audio-player') !== undefined){
				videojs.getPlayer('audio-player').dispose();
			};
			var player = videojs('audio-player', {
				audioOnlyMode: true,
			    autoplay: true,
				controls: true,
				preload: 'auto',
				playbackRates: [0.75, 1, 1.25, 1.5],
				controlBar: {
		          remainingTimeDisplay: false,
		          currentTimeDisplay: true,
		          durationDisplay: true,
			      skipButtons: {forward: 10, backward: 10}
				}
			});

			var cw = document.getElementById('page-frame').contentWindow;
			<% case pg['file_type'] when 'pdf' %>
			cw.document.getElementById('viewer').addEventListener('pagerendered', function(){
				setPlayerPosition();
			});
			<% else %>
				setPlayerPosition();
			<% end %>
			cw.addEventListener('resize', function(){
				setPlayerPosition();
			});
			function setPlayerPosition() {
				document.getElementById('audio-player').style.display = 'block'
				viewerHeight = cw.document.getElementById('viewer').offsetHeight;
				// 32px is for main toolbar height
				document.getElementById('audio-player').style.top = (viewerHeight + 32) + 'px';
			};
		<% end %>
	};
</script>
